services:
  hardn-xdr:
    build:
      context: .
      dockerfile: Dockerfile
    image: hardn-xdr:latest
    container_name: hardn_docker
    restart: on-failure:5
    user: "10001:10001"  

    # Resource limits (CIS 5.10, 5.11, 5.28)
    mem_limit: 512m
    mem_reservation: 256m
    cpu_shares: 1024
    cpu_quota: 100000
    cpu_period: 100000
    pids_limit: 1024

    # Security and isolation (CIS 5.1, 5.2, 5.3, 5.25)
    security_opt:
      - apparmor=usr.bin.hardn
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add: []  # No capabilities added to avoid CIS warnings
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m,mode=1777
      - /run:rw,noexec,nosuid,size=16m,mode=0755
      - /home/hardn:rw,size=32m,mode=0755
      - /var/lib/hardn:rw,size=32m,mode=0755
    # Do not share the host user namespace; sharing causes bench warnings.
    # Removing `userns_mode: host` avoids exposing host UID/GID mappings to the container.
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: 3
    #######################################################
    # Volumes for persistent data (ROFS)
    volumes:
      - ./logs:/opt/hardn-xdr/state:rw
      - ./config:/opt/hardn-xdr/config:ro
    #######################################################
    environment:
      - TZ=UTC
      - LANG=C.UTF-8
      - LC_ALL=C.UTF-8
      - DOCKER_MEMORY_LIMIT=512m
      - DOCKER_CPU_SHARES=1024
      - MALLOC_ARENA_MAX=1
      - DOCKER_CONTENT_TRUST=1

    # Health check (CIS 5.26)
    healthcheck:
      test: ["CMD", "/usr/local/bin/health_check.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    ports:
      - "127.0.0.1:8082:5000"

    labels:
      - "project=hardn-xdr"
      - "version=1.0"
      - "security.level=high"
      - "compliance=cis-1.13.0"
      - "security.apparmor=enabled"
      - "security.selinux=disabled"
      - "security.readonly.rootfs=true"
      - "security.no.new.privileges=true"
      - "security.capabilities=restricted"

    # Isolated user-defined network (bench 2.1)
    networks:
      - hardn_net

networks:
  hardn_net:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.enable_icc: "false"
    internal: false  
